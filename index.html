<!doctype html>
<html>
  <head>
    <title>Howard's Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box;}
      body { font: 13px Helvetica, Arial; }
	  #chatInputBar{ width: 100%; overflow: hidden; background-color: #000;padding: 3px;}
	  #chatInputBar input { border: 0; padding: 10px; width: 100%;}
	  #chatInputBar select {border: 0; padding: 9px; float: left;}
	  #chatInputBar span { display: block; overflow: hidden; padding: 0 5px;}
	  #chatInputBar button { border: 0; padding: 10px; width: auto; background: rgb(130, 224, 255); float: right;}
      #messages {width:100%; position: fixed; top:0; bottom: 8%; overflow:auto;}
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
	  #typingMessage{background: yellow; width:100%;}
	  #footer{position: fixed; bottom: 0; width:100%;}
	  #downloadHistroy{ position: fixed; top: 0; right: 0;}
    </style>
	<script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.3.js"></script>
	<script>
		function downloadInnerHtml() {
			var elHtml = document.getElementById('messages').innerHTML;
			var link = document.createElement('a');
			mimeType = 'text/html' || 'text/plain';

			var currentdate = new Date(); 
			var filename = currentdate.getFullYear()+'-'+(currentdate.getMonth()+1)+'-'+currentdate.getDate()+'_history.html';
			link.setAttribute('download', filename);
			link.setAttribute('href', 'data:text/html; charset=UTF-8,' + '<meta charset="UTF-8" />' + encodeURIComponent(elHtml));
			link.click(); 
		}
	</script>
  </head>
<body>
    <ul id="messages">
    </ul>
	<div id="footer">
		<div id="typingMessage">
		</div>
		<form action="">
			<div id="chatInputBar">
				<button>Send</button>
				<select id = "userSelect">
					<option value="all">All</option>
				</select>
				<span><input id="m" autocomplete="off"/></span>
			</div>
		</form>
	</div>
	<div id = "downloadHistroy">
		<button onclick ="downloadInnerHtml()">Save</button>
	</div>
    <script>
		//check login device to change font-size
		var isMobile = {
			Android: function() {
				return navigator.userAgent.match(/Android/i);
			},
			BlackBerry: function() {
				return navigator.userAgent.match(/BlackBerry/i);
			},
			iOS: function() {
				return navigator.userAgent.match(/iPhone|iPad|iPod/i);
			},
			Opera: function() {
				return navigator.userAgent.match(/Opera Mini/i);
			},
			Windows: function() {
				return navigator.userAgent.match(/IEMobile/i);
			},
			any: function() {
				return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
			}
		};
		if(isMobile.any()){
			$('*').css('font-size','30pt');
		}
		else{
			$('*').css('font-size','12pt');
		}
	</script>
	<script>
		var socket = io();
		var userName;
		var receiveName = 'all';

		socket.on('add userList', function (name) {
			//add user list to selector without user-self
			if(userName!=name){
				$("#userSelect").append($("<option></option>").attr("value", name).text(name));
			}
        });
		
		socket.on('userName exist', function (name) {
            alert("Your user name "+name+" was exist!!");
			//user name exist, ask again
			AskUserName();
        });
		
        socket.on('chat message', function (msg) {
            $('#messages').append($('<li>').text(msg));
			ScrollBarMoveBottom();
			notifyMe();
        });
		
		socket.on('private message', function (msg) {
            $('#messages').append($('<li>').text(msg).css( 'color', '#FF0000' ));
			ScrollBarMoveBottom();
			notifyMe();
        });
		
		socket.on('user join',function (Name) {
			$('#messages').append($('<li>').text(GetCurrentDate()+ Name + ' Join'));
			ScrollBarMoveBottom();
		});
		
		socket.on('typing message', function (typingUsers) {
			if(typingUsers.length != 0){
				$('#typingMessage').text(typingUsers + " is typing...");
			}
			else{
				$('#typingMessage').text("");
			}
        });
		
		socket.on('user left', function (Name) {
            $('#messages').append($('<li>').text(GetCurrentDate()+ Name + ' Left'));
			//remove leaved user in selector 
			$('#userSelect').find('[value="'+Name+'"]').remove();
			socket.emit('stop typing',userName);
			ScrollBarMoveBottom();
        });
		
		$('form').submit(function () {
			if(receiveName == 'all'){
				var msg = GetCurrentDate() +userName+ ": "+$('#m').val();
				$('#messages').append($('<li>').text(msg));
				ScrollBarMoveBottom();
				socket.emit('chat message', msg);
			}
			else{
			var msg = GetCurrentDate()+userName+" to "+receiveName +": "+$('#m').val();
				$('#messages').append($('<li>').text(msg).css( 'color', '#FF0000' ));
				ScrollBarMoveBottom();
				socket.emit('private message', receiveName, msg);
			}
			$('#m').val('');
			$('#m').focus();
			return false;
        });
		
		//change target User
		$("#userSelect").change(function(){
			receiveName = $("#userSelect").find(":selected").val();
			socket.emit('stop typing',userName);
		});
		
		//who is typing
		$('#m').keyup(function() {
			if(receiveName == 'all'){
				if($('#m').val() != ""){
					socket.emit('start typing',userName);
				}
				else{
					socket.emit('stop typing',userName);
				}
			}
		});

		$(window).on('beforeunload', function () {
            return "Are you sure want to leave??";
        });
		
		function AskUserName(){
			userName = prompt("Please enter your name", "Howard");
			socket.emit('new user',userName);
		}
		
		//make message scrollbar always at bottom
		function ScrollBarMoveBottom(){
			$("#messages").animate({
				scrollTop: $("#messages")[0].scrollHeight
			},'slow');
		}
		
		function notifyMe() {
			// Check if the browser supports notifications
			if (("Notification" in window)) {
				// Check whether notification permissions have already been granted
				if (Notification.permission === "granted") {
					// If it's okay let's create a notification
					var notification = new Notification("You've got new messages.");
					setTimeout(notification.close.bind(notification), 1000);
				}
				// Otherwise, we need to ask the user for permission
				else if (Notification.permission !== 'denied') {
					Notification.requestPermission(function (permission) {
						// If the user accepts, let's create a notification
						if (permission === "granted") {
							var notification = new Notification("You've got new messages.");
							setTimeout(notification.close.bind(notification), 1000);
						}
					});
				}
			}
		}
		
		function GetCurrentDate(){
			var currentdate = new Date(); 
			var datetime ="[" + currentdate.getHours() + ":" + currentdate.getMinutes() + ":" + currentdate.getSeconds()+"]";
			return datetime;
		}
		
		AskUserName();
    </script>
</body>
</html>
